# 动作价值方程

由于 $G_t=R_{t+1}+\gamma G_{t+1}$，所以：
$$\begin{aligned}
q_{\pi}(s,a)& =\mathbb{E}[G_t|S_t=s,A_t=a] \\
&=\mathbb{E}[R_{t+1}+\gamma G_{t+1}|S_t=s,A_t=a] \\
&=\mathbb{E}[R_{t+1}|S_t=s,A_t=a]+\gamma\mathbb{E}[G_{t+1}|S_t=s,A_t=a]
\end{aligned}$$
即动作价值可拆分为即时回报加上衰减的未来回报。
+ 即时回报为：$\mathbb{E}[R_{t+1}|S_t=s,A_t=a]=\sum_{r \in \mathcal{R}}p(r|s,a)r$
+ 未来回报为：$\mathbb{E}[G_{t+1}|S_t=s,A_t=a]=\sum_{s' \in \mathcal{S}}p(s'|s,a)v_{\pi}(s')$
得到动作价值：
$$ q_{\pi}(s,a)=\sum_{r \in \mathcal{R}}p(r|s,a)r+ \gamma \sum_{s' \in \mathcal{S}}p(s'|s,a)v_{\pi}(s')$$

根据动作价值函数与状态价值的关系：$v_{\pi}(s)=\sum_{a \in \mathcal{A}}q_\pi(s,a) \pi(a|s)$，这也与[[状态价值方程]]吻合。

将状态价值用动作价值替代后得：
$$q_\pi(s,a)=\sum_{r\in\mathcal{R}}p(r|s,a)r+\gamma\sum_{s'\in\mathcal{S}}p(s'|s,a)\sum_{a'\in\mathcal{A}(s')}\pi(a'|s')q_\pi(s',a')$$
矩阵形式为：
$$ Q_{\pi}=R+\gamma P \Pi Q_{\pi} $$
其中：
+ $Q_{\pi}$ 为状态价值矩阵，第 $(s,a)$ 项为 $q_{\pi}(s,a)$
+ $R$ 为即时奖励的期望，第 $(s,a)$ 项为 $\mathbb{E}[R_{t+1}|S_t=s,A_t=a]$
+ 


