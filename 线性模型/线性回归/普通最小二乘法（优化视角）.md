# 普通最小二乘法（优化视角）

使用 $X\beta$ 拟合 $Y$，其中协变量矩阵 $X$ 已知，$\beta$ 为使两者度量最小的最优解：
$$\hat{\beta}=\arg\min_b\|Y-Xb\|^2$$

目标函数是 $b$ 的二次函数，是[[凸优化]]问题，故最优点满足一阶条件：
$$-2\sum_{i=1}^nx_i(y_i-x_i^\mathrm{T}\hat{\beta})=0$$
可简化为：
$$\sum_{i=1}^nx_i(y_i-x_i^\mathrm{T}\hat{\beta})=0\Longleftrightarrow X^\mathrm{T}(Y-X\hat{\beta})=0.$$
>[!theorem] 普通最小二乘系数
若 $X^\mathsf{T}X$ *可逆*，则解为：
$$ \hat{\beta}=(X^\mathsf{T}X)^{-1}X^\mathsf{T}Y $$

## 解的存在条件

由于 $X^\mathsf{T}X\alpha=0$ 与 $X\alpha=0$ 同解，故两者的秩相同。若 $X^\mathsf{T}X$ 可逆，则其秩等于 $X$ 的列向量数，即 $X$ *列向量线性独立*。（ $X$ 的列向量数必须小于其行向量数。
）

## 几何解释

由于 $Xb$ 是 $X$ 列向量的线性组合，且对 $b$ 没有限制，故问题可视为在 $X$ 的列向量空间 $\mathcal{C}(X)$ 中找出与 $Y$ 最接近的向量，即 $Y$ 在 $\mathcal{C}(X)$ 上的[[投影]]。

由此可知其残差 $\hat{\varepsilon}= Y-X\hat{\beta}$ 应正交与空间 $\mathcal{C}(X)$ ，即
$$ X^\mathsf{T}(Y-X \hat{\beta})=0 $$
并且由广义勾股定理可得：
$$ \|Y\|^2=\|X \hat{\beta}\|^2+\|\hat{\varepsilon}\|^2 $$

在一般情况下，协变量矩阵包含一个截距列 $\mathbf{}{1}_n$，所以
$$ \mathbf{1}^\mathsf{T}_n \hat{\varepsilon}=0 \implies \sum_{i=1}^{n}\hat{\varepsilon}_i=0 $$

## 帽子矩阵(hat matrix)

用最小二乘系数的拟合结果为：
$$ \hat{Y}=X \hat{\beta}=X(X^\mathsf{T}X)^{-1}X^\mathsf{T}Y $$
其中记
$$H=X(X^\mathsf{T}X)^{-1}X^\mathsf{T} $$
称为**帽子矩阵**(hat matrix)。

由于
$$\begin{align}
H^2 &=X(X^\mathrm{T}X)^{-1}X^\mathrm{T}X(X^\mathrm{T}X)^{-1}X^\mathrm{T}\\
&=X(X^\mathrm{T}X)^{-1}X^\mathrm{T}\\
&=H \\
H^{\mathrm{T}} &= \left\{X(X^{\mathrm{T}}X)^{-1}X^{\mathrm{T}}\right\}^{\mathrm{T}}\\
&= X(X^{\mathrm{T}}X)^{-1}X^{\mathrm{T}}\\
&= H
\end{align}$$
故其为[[投影矩阵]]。

其秩与迹相等：
$$\begin{align}
\operatorname{rank}(H)=\operatorname{trace}(H)& =\mathrm{trace}\left\{X(X^{\mathrm{T}}X)^{-1}X^{\mathrm{T}}\right\} \\
&=\mathrm{trace}\left\{(X^{\mathrm{T}}X)^{-1}X^{\mathrm{T}}X\right\} \\
&=\mathrm{trace}(I_{p})=p.
\end{align}$$

对于 $X$ 的列向量空间 $\mathcal{C}(X)$ 中的任意元素 $v=Xb$，经 $H$ 投影后不发生改变：
$$ Hv=X(X^\mathsf{T}X)^{-1}X^\mathsf{T}Xb=Xb=v $$
反之，若向量 $v$ 经 $H$ 投影后不发生改变，则其必然属于空间 $\mathcal{C}(X)$：
$$ v=Hv=X(X^\mathsf{T}X)^{-1}X^\mathsf{T}v=X \left[ X^\mathsf{T}X)^{-1}X^\mathsf{T}v \right] $$

向量 $w$ 正交与空间 $\mathcal{C}(X)$ 的充要条件为 $X^\mathsf{T}w=0$。
若 $w \perp \mathcal{C}(X)$，则
$$ Hw=X(X^\mathsf{T}X)^{-1}X^\mathsf{T}w=0 $$
反之，若 $Hw=0$，即
$$ X(X^\mathsf{T}X)^{-1}X^\mathsf{T}w=0 \implies w^\mathsf{T}X(X^\mathsf{T}X)^{-1}X^\mathsf{T}w=0 $$

